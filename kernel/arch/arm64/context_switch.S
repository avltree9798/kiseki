/*
 * Kiseki OS - ARM64 Context Switch
 *
 * Saves and restores thread register state for the scheduler.
 * Saves callee-saved registers (x19-x30), SP, and restores them
 * on the new thread's context.
 */

.section .text
.global context_switch

/*
 * context_switch(old_ctx, new_ctx)
 *
 * x0 = pointer to old thread's saved register context (uint64_t[32])
 * x1 = pointer to new thread's saved register context (uint64_t[32])
 *
 * Saves callee-saved registers (x19-x30, SP) to old context,
 * restores them from new context, and returns.
 */
context_switch:
    /* Save callee-saved registers to old context */
    stp     x19, x20, [x0, #0]
    stp     x21, x22, [x0, #16]
    stp     x23, x24, [x0, #32]
    stp     x25, x26, [x0, #48]
    stp     x27, x28, [x0, #64]
    stp     x29, x30, [x0, #80]    /* x29=FP, x30=LR */
    mov     x2, sp
    str     x2, [x0, #96]           /* Save SP */

    /* Restore callee-saved registers from new context */
    ldp     x19, x20, [x1, #0]
    ldp     x21, x22, [x1, #16]
    ldp     x23, x24, [x1, #32]
    ldp     x25, x26, [x1, #48]
    ldp     x27, x28, [x1, #64]
    ldp     x29, x30, [x1, #80]
    ldr     x2, [x1, #96]
    mov     sp, x2                   /* Restore SP */

    ret                              /* Return via restored LR (x30) */
